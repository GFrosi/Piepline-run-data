# Piepline-run-data
Pipeline to create the json input files per sample and submit the IHEC pipeline using each one


## Submission IHEC pipeline by parts

- 1. Things to adjust before run the pipeline:

    -    1.1 Move all .gz files to data_srr dir and create a list of GSEs (gse_list.txt)

- 2. Generate Json .sh files

    - 2.1 Example comand line: 
    ```
    python pipeline_json.py -l gse_list.txt -c chipseq_json_generator -m SRR-samples -p 2021_GSE -g Corresponding_Input_Json_IHEC/srr_data_struct.py
    ```

```
usage: pipeline_json.py [-h] -l LIST -c CHIP -m METADATA -p PATH -g GITPATH

A tool to optimize the json creation for the IHEC pipeline. Returns jsons for
each IP sample with their respective corresponding controls

optional arguments:
  -h, --help            show this help message and exit
  -l LIST, --list LIST  List of GSEs in a txt file
  -c CHIP, --chip CHIP  Absolute path to chipseq generator dir, containing the
                        config dir, gsm_seq.py and chipseq_json_generator.py
  -m METADATA, --metadata METADATA
                        Absolute path to metadata table. This table is
                        separated by | (pipe)
  -p PATH, --path PATH  Absolute path to the directory with the GSE
                        directories
  -g GITPATH, --gitpath GITPATH
                        Absolute path to the directory (i.e git repo) with the
                        srr_struct.py
```


- 3. Generate IHEC .sh 

    - 3.1 Example comand line:

    ```
    python pipeline_IHEC.py -i chip-seq-ihec-test/singularity-wrapper-encode/integrative_analysis_chip/encode-wrapper -l gse_list.txt -g samples/2021_GSE -o /chip-seq-ihec-test/singularity-wrapper-encode/integrative_analysis_chip/encode-wrapper/pipeline-frosi-outputs/slurm-sing-frosi
    ```
```
usage: pipeline_IHEC.py [-h] -i IHEC -g GSE -l LIST -o OUT

A tool to create the .sh file for each json for each series to the IHEC
pipeline

optional arguments:
  -h, --help            show this help message and exit
  -i IHEC, --ihec IHEC  Absolute path to the
                        piperunner_ihec_slurm_singularity.sh
  -g GSE, --gse GSE     Absolute path to the directory containing the gse
                        directories
  -l LIST, --list LIST  List of GSEs in a txt file
  -o OUT, --out OUT     Absolut path to the ihec.sh output
  ```


## Submission IHEC pipeline using Nextflow

- 1. Things to adjust before run the Nextflow pipeline:
     -    1.1 Move all .gz files to data_srr dir and create a list of GSEs (gse_list.txt)
     -    1.2 Change the config file with the correct paths
     -    1.3 Copy the runNextflow.sh to the directory with the GSEs (each GSE dir contains the fastq.gz files)
     -    1.4 Run the runNextflow.sh (you can adjust the walltime of this .sh file)

- 2. Example:
    ```
    sbatch runNexflow.sh
    ```


## Script to get the samples to relaunch

```
python 3.7 and create a virtual env - requirements.txt
```
- 1. Example command line:
    ```
    python main_get_srr_error.py -d df_metadata.csv -l gse_list.txt -m list_macs2_pval.txt -p GSE_directories
    ```
  
```
usage: main_get_srr_error.py [-h] -d DATAFRAME -l LISTGSE [-m MACS2PVAL]
                             [-p PATHTOGSE]

A script to filter the SRR and GSEs that should be relaunched to IHEC pipeline

optional arguments:
  -h, --help            show this help message and exit
  -d DATAFRAME, --dataframe DATAFRAME
                        the absolut path to the dataframe with the metadata
                        information including GSE and SRR column
  -l LISTGSE, --listgse LISTGSE
                        the absolut path to the txt file containing the
                        desired GSEs
  -m MACS2PVAL, --macs2pval MACS2PVAL
                        the absolut path to the pval.bigwig files generated by
                        macs2 step - IHEC pipeline
  -p PATHTOGSE, --pathtogse PATHTOGSE
                        the absolut path to the GSE directories
```
